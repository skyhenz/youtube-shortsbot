name: Auto Upload Shorts

on:
    schedule:
        # Jalan setiap 8 jam (Di jam 00:00, 08:00, 16:00 UTC)
        # Sesuaikan dengan jam WIB (UTC+7)
        - cron: "0 0,8,16 * * *"
    workflow_dispatch: # Supaya bisa dijalankan manual lewat tombol

jobs:
    build-and-run:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v2

            - name: Setup Node.js
              uses: actions/setup-node@v2
              with:
                  node-version: "18"

            - name: Install System Dependencies (FFmpeg)
              run: |
                  sudo apt-get update
                  sudo apt-get install -y ffmpeg

            - name: Install Node Dependencies
              run: npm install

            - name: Create Config Files from Secrets
              run: |
                  # Buat .env dari Secrets
                  echo "YOUTUBE_CLIENT_ID=${{ secrets.YOUTUBE_CLIENT_ID }}" >> .env
                  echo "YOUTUBE_CLIENT_SECRET=${{ secrets.YOUTUBE_CLIENT_SECRET }}" >> .env
                  echo "YOUTUBE_REFRESH_TOKEN=${{ secrets.YOUTUBE_REFRESH_TOKEN }}" >> .env
                  echo "PEXELS_API_KEY=${{ secrets.PEXELS_API_KEY }}" >> .env
                  echo "SINGLE_RUN=true" >> .env
                  echo "MODE_PROD=true" >> .env

            - name: Run Bot (Single Cycle)
              run: npm start

            - name: Commit Logs & Status (Opsional)
              # Simpan log video yang sudah terupload ke repo, supaya tidak upload ulang
              run: |
                  git config --global user.name 'Bot Action'
                  git config --global user.email 'bot@action.com'
                  git add logs/processed.json logs/upload_log_*.json
                  git commit -m "Update logs [skip ci]" || echo "No changes to commit"
                  git push
